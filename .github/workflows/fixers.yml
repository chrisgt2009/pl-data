name: Refresh Fixtures

concurrency:
  group: pl-data-commit
  cancel-in-progress: false

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  fixtures:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug environment
        run: |
          echo "BASE FIXTURES? => ${{ vars.URL_FIXTURES }}"
          echo "BASE STANDINGS? => ${{ vars.URL_STANDINGS }}"
          echo "RAPID KEY present? => ${{ secrets.RAPIDAPI_KEY != '' }}"
          ls -la data/ || true

      # ---------------- FIXTURES ----------------
      - id: fixtures_week
        name: Refresh fixtures (API-Football)
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_FIXTURES }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          FREE_SEASON: '2023'
          START_DATE: '2023-05-01'
          END_DATE: '2023-05-31'
        run: |
          set -euo pipefail
          mkdir -p data/

          OUT="data/fixtures_week.json"
          TMPBODY="$(mktemp)"

          [[ -z "${BASE_URL:-}" ]] && {
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          FINAL_URL="${BASE_URL}&season=${FREE_SEASON}&from=${START_DATE}&to=${END_DATE}"

          CODE=$(curl -sS -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "code=$CODE" >> "$GITHUB_OUTPUT"

          if [[ "$CODE" != "200" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Must ensure response is an array
          LEN=$(jq -r '(.response | type=="array")? // empty' "$TMPBODY")
          if [[ "$LEN" != "true" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Wrap correctly for your Swift app
          NORM=$(mktemp)
          jq '{matches: .response}' "$TMPBODY" > "$NORM"

          if ! cmp -s "$NORM" "$OUT"; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- STANDINGS ----------------
      - id: standings
        name: Refresh standings (API-Football)
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_STANDINGS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          FREE_SEASON: '2023'
          LEAGUE_ID: '39'
        run: |
          set -euo pipefail
          mkdir -p data/

          OUT="data/standings.json"
          TMPBODY="$(mktemp)"

          [[ -z "${BASE_URL:-}" ]] && {
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          }

          FINAL_URL="${BASE_URL}&season=${FREE_SEASON}&league=${LEAGUE_ID}"

          CODE=$(curl -sS -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "code=$CODE" >> "$GITHUB_OUTPUT"

          if [[ "$CODE" != "200" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LEN=$(jq -r '(.response | type=="array")? // empty' "$TMPBODY")
          if [[ "$LEN" != "true" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NORM=$(mktemp)
          jq '{standings: .response}' "$TMPBODY" > "$NORM"

          if ! cmp -s "$NORM" "$OUT"; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- COMMIT ----------------
      - name: Commit & push
        if: steps.fixtures_week.outputs.changed == 'true' || steps.standings.outputs.changed == 'true'
        run: |
          git config user.name "pl-bot"
          git config user.email "pl-bot@users.noreply.github.com"
          git add data/*.json
          git commit -m "Update fixtures & standings"
          git push
