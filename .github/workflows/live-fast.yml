name: live-fast

on:
  workflow_dispatch:
  schedule:
    # run every 30 minutes (adjust as you like)
    - cron: "*/30 * * * *"

permissions:
  contents: write

concurrency:
  group: live-fast-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-live-json:
    runs-on: ubuntu-latest

    steps:
      # --- Module 1: checkout -------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --- Module 2: setup python --------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --- Module 3: gate switch (decide if we should fetch/update) ----------
      - id: gate
        name: Gate: decide to fetch
        shell: bash
        run: |
          set -euo pipefail
          # TODO: replace this logic with your real gating rules if different
          echo "should_fetch=yes" >> "$GITHUB_OUTPUT"

      # --- Module 4: fetch or diff inputs & compute ETag ----------------------
      - id: fetch
        name: Fetch inputs & compute ETag
        shell: bash
        run: |
          set -euo pipefail
          # TODO: replace with your real fetch + diff logic.
          # Emit two outputs:
          #  - any_changed: 'true' | 'false'
          #  - new_etag:    computed string (or keep previous)
          echo "any_changed=true" >> "$GITHUB_OUTPUT"
          echo "new_etag=$(date -u +%Y%m%dT%H%M%SZ)" >> "$GITHUB_OUTPUT"

      # --- Module 5: build live_today.new.json (safe heredoc) -----------------
      - name: Build live_today.new.json
        if: ${{ steps.gate.outputs.should_fetch == 'yes' && steps.fetch.outputs.any_changed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          python - <<'PY'
          import json, datetime as d
          from pathlib import Path

          SRC = Path("data/live_today.json")       # existing input (if present)
          DST = Path("data/live_today.new.json")   # output

          def from_iso(text: str | None):
            if not text:
              return None
            s = text.strip()
            # Make "Z" explicit to avoid fromisoformat quirks
            if s.endswith("Z"):
              s = s[:-1] + "+00:00"
            try:
              return d.datetime.fromisoformat(s)
            except Exception:
              return None

          now = d.datetime.utcnow().replace(tzinfo=d.timezone.utc)

          # Load current data if it exists; otherwise start with an empty shell
          today = {}
          if SRC.exists():
            try:
              today = json.loads(SRC.read_text(encoding="utf-8"))
            except Exception:
              today = {}

          # Example light-touch normalization/derived fields (safe if absent)
          matches = today.get("matches", [])
          for m in matches if isinstance(matches, list) else []:
            status = (m.get("status") or "").lower()
            kick   = from_iso(m.get("utcDate"))
            m["started"] = bool(kick and now >= kick)
            m["is_live"] = status in {"live", "inprogress", "in-progress"}

          # Include a generated timestamp for traceability
          out = dict(today)
          out["generatedAt"] = now.isoformat()

          DST.write_text(
            json.dumps(out, separators=(",", ":"), sort_keys=True),
            encoding="utf-8"
          )
          PY

      # --- Module 6: update ETag store ---------------------------------------
      - name: Update ETag store
        if: ${{ steps.gate.outputs.should_fetch == 'yes' && steps.fetch.outputs.any_changed == 'true' }}
        env:
          NEW_ETAG: ${{ steps.fetch.outputs.new_etag }}
        shell: bash
        run: |
          set -euo pipefail
          echo -n "$NEW_ETAG" > data/live_today.etag

      # --- Module 7: commit changes ------------------------------------------
      - name: Commit & push changes
        if: ${{ steps.gate.outputs.should_fetch == 'yes' && steps.fetch.outputs.any_changed == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/live_today.new.json data/live_today.etag || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update live_today artifacts [skip ci]"
            git push
          fi
