name: Live PL (fast, serialized, free-safe)

concurrency:
  group: pl-live
  cancel-in-progress: false

on:
  schedule:
    - cron: "*/5 11-20 * * 6,0"
    - cron: "*/6 18-22 * * 1-5"
    - cron: "0 9-23 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  live:
    runs-on: ubuntu-latest
    env:
      FD_TOKEN: ${{ secrets.FD_API_TOKEN }}
      UA: live-bot/1.0 (+github.com/${{ github.repository }})

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure data directory
        run: mkdir -p data

      - name: Compute UTC date and timestamp
        id: when
        run: |
          echo "TODAY=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "NOW_ISO=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Freshness check (<75s, skip if recent)
        id: freshness
        shell: bash
        run: |
          if [ -f data/live_today.json ]; then
            cat > check_freshness.py << 'EOF'
import json, datetime, sys
try:
    j = json.load(open("data/live_today.json"))
    t = j.get("lastUpdatedUTC") or j.get("serverNowUTC")
    if not t:
        sys.exit(1)
    dt = datetime.datetime.fromisoformat(t.replace("Z", "+00:00"))
    now = datetime.datetime.now(datetime.timezone.utc)
    print(int((now - dt).total_seconds()))
except Exception:
    print("")
EOF
            AGE=$(python check_freshness.py)
            if [ -n "$AGE" ] && [ "$AGE" -lt 75 ]; then
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "Recently updated ($AGE s). Skipping."
              exit 0
            fi
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Gate check (live or KO window)
        id: gate
        if: steps.freshness.outputs.skip != 'true'
        shell: bash
        env:
          TODAY: ${{ steps.when.outputs.TODAY }}
          NOW_ISO: ${{ steps.when.outputs.NOW_ISO }}
        run: |
          SHOULD="no"
          if [ -f data/live_today.json ]; then
            cat > check_live.py << 'EOF'
import json
try:
    with open("data/live_today.json") as f:
        data = json.load(f)
    live = any(m.get("status") in ("IN_PLAY", "PAUSED") for m in data.get("matches", []))
    print("yes" if live else "no")
except:
    print("no")
EOF
            LIVE=$(python check_live.py)
            [ "$LIVE" = "yes" ] && SHOULD="yes"
          fi

          if [ "$SHOULD" = "no" ] && [ -f data/fixtures_week.json ]; then
            cat > check_window.py << 'EOF'
import os, json, datetime as d
today = os.getenv("TODAY", "")
now_iso = os.getenv("NOW_ISO", "")
try:
    with open("data/fixtures_week.json") as f:
        matches = [m for m in json.load(f).get("matches", []) if m.get("utcDate", "").startswith(today)]
    if not matches:
        print("no"); exit()
    now = d.datetime.fromisoformat(now_iso.replace("Z", "+00:00"))
    ks = [d.datetime.fromisoformat(m["utcDate"].replace("Z", "+00:00")) for m in matches if m.get("utcDate")]
    if not ks:
        print("no"); exit()
    start = min(ks) - d.timedelta(minutes=20)
    end = max(ks) + d.timedelta(minutes=130)
    print("yes" if start <= now <= end else "no")
except:
    print("no")
EOF
            SHOULD=$(python check_window.py)
          fi

          echo "should_fetch=$SHOULD" >> "$GITHUB_OUTPUT"

      - name: Read previous live ETag
        id: et
        if: steps.gate.outputs.should_fetch == 'yes'
        shell: bash
        run: |
          if [ -f data/etags_live.json ]; then
            echo "etag=$(python -c 'import json; print(json.load(open("data/etags_live.json")).get("today", ""))' 2>/dev/null || true)" >> "$GITHUB_OUTPUT"
          else
            echo "etag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch todayâ€™s matches with ETag
        id: fetch
        if: steps.gate.outputs.should_fetch == 'yes'
        shell: bash
        run: |
          URL="https://api.football-data.org/v4/competitions/PL/matches?dateFrom=${{ steps.when.outputs.TODAY }}&dateTo=${{ steps.when.outputs.TODAY }}"
          if [ -n "${{ steps.et.outputs.etag }}" ]; then
            code=$(curl -sS --retry 2 --retry-delay 2 --connect-timeout 15               -H "User-Agent: $UA" -H "X-Auth-Token: $FD_TOKEN"               -H "If-None-Match: ${{ steps.et.outputs.etag }}"               -D headers.txt -o today.raw.json --write-out "%{http_code}" "$URL")
          else
            code=$(curl -sS --retry 2 --retry-delay 2 --connect-timeout 15               -H "User-Agent: $UA" -H "X-Auth-Token: $FD_TOKEN"               -D headers.txt -o today.raw.json --write-out "%{http_code}" "$URL")
          fi
          echo "code=$code" >> "$GITHUB_OUTPUT"
          if [ "$code" = "200" ]; then
            new_etag=$(awk 'BEGIN{IGNORECASE=1} /^etag:/{print $2; exit}' headers.txt | tr -d '
')
            echo "any_changed=true" >> "$GITHUB_OUTPUT"
            echo "new_etag=$new_etag" >> "$GITHUB_OUTPUT"
          else
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build live_today.json
        if: steps.fetch.outputs.any_changed == 'true'
        shell: bash
        run: |
          cat > build_live.py << 'EOF'
import json, datetime
now = datetime.datetime.now(datetime.timezone.utc)
today = json.load(open("today.raw.json"))
def phase(status, utc):
    try:
        kick = datetime.datetime.fromisoformat(utc.replace("Z", "+00:00"))
        mins = int(max(0, (now - kick).total_seconds() // 60))
    except:
        return 0, ""
    if status in ("SCHEDULED", "TIMED"): return mins, "Today"
    if status == "IN_PLAY": return mins, f"{mins}'" if mins < 90 else f"90+{mins - 90}'"
    if status == "PAUSED": return 45, "Half-Time"
    if status == "FINISHED": return 90, "FT"
    return mins, status or ""
out = {"serverNowUTC": now.isoformat(), "lastUpdatedUTC": now.isoformat(), "matches": []}
for m in today.get("matches", []):
    mins, label = phase(m.get("status"), m.get("utcDate"))
    ft = (m.get("score") or {}).get("fullTime", {})
    out["matches"].append({
        "id": m.get("id"), "utcDate": m.get("utcDate"), "status": m.get("status"),
        "approxMinute": mins, "phase": label,
        "home": {**m.get("homeTeam", {}), "score": ft.get("home")},
        "away": {**m.get("awayTeam", {}), "score": ft.get("away")},
    })
json.dump(out, open("data/live_today.new.json", "w"), separators=(",", ":"), sort_keys=True)
EOF
          python build_live.py

      - name: Update ETag file
        if: steps.fetch.outputs.any_changed == 'true'
        env:
          NEW_ETAG: ${{ steps.fetch.outputs.new_etag }}
        shell: bash
        run: |
          cat > update_etag.py << 'EOF'
import json, os
path = "data/etags_live.json"
et = {}
try:
    et = json.load(open(path))
except:
    pass
new = os.getenv("NEW_ETAG", "").strip()
if new:
    et["today"] = new
json.dump(et, open("data/etags_live.new.json", "w"), separators=(",", ":"), sort_keys=True)
EOF
          python update_etag.py

      - name: Commit updated files
        if: steps.fetch.outputs.any_changed == 'true'
        shell: bash
        run: |
          set -e
          CHANGED=0
          for f in live_today etags_live; do
            if [ -f "data/$f.new.json" ]; then
              if [ ! -f "data/$f.json" ] || ! cmp -s "data/$f.new.json" "data/$f.json"; then
                mv "data/$f.new.json" "data/$f.json"
                CHANGED=1
              else
                rm "data/$f.new.json"
              fi
            fi
          done
          rm -f headers.txt today.raw.json || true
          if [ "$CHANGED" -eq 1 ]; then
            git config user.name "pl-bot"
            git config user.email "pl-bot@users.noreply.github.com"
            git add data/*.json
            git commit -m "Update live_today $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            for i in 1 2 3; do
              if git pull --rebase origin main && git push origin HEAD:main; then
                echo "Push successful"
                exit 0
              fi
              echo "Retrying push ($i)..."
              sleep $((i * 2))
            done
            echo "Failed to push after 3 attempts"
            exit 1
          else
            echo "No changes to commit."
