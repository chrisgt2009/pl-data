name: live-data

on:
  workflow_dispatch:
  schedule:
    # --- Live windows (UTC) ---
    # Weekdays (Mon–Fri): every 10 minutes 18:00–22:59
    - cron: "*/10 18-22 * * 1-5"
    # Weekends (Sat–Sun): every 10 minutes 11:00–22:59
    - cron: "*/10 11-22 * * 6,0"

    # --- Outside live windows (light touch to save free minutes) ---
    # Weekdays (Mon–Fri): 4x/day
    - cron: "0 8,12,16,23 * * 1-5"
    # Weekends (Sat–Sun): 5x/day
    - cron: "0 9,12,15,18,21 * * 6,0"

permissions:
  contents: write

# Never cancel an in-progress run; new ones will queue if needed.
concurrency:
  group: live-data-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - id: build
        name: Build/normalize live data (no-op if unchanged)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data

          # Reads existing data/live_today.json (if present), performs a small,
          # deterministic normalization, and only writes if content actually changes.
          python - <<'PY'
          import json, datetime as dt
          from pathlib import Path

          dst = Path("data/live_today.json")

          def load_json(p: Path):
            if not p.exists():
              return None
            try:
              return json.loads(p.read_text(encoding="utf-8"))
            except Exception:
              return None

          def from_iso(s: str | None):
            if not s:
              return None
            s = s.strip()
            if s.endswith("Z"):
              s = s[:-1] + "+00:00"
            try:
              return dt.datetime.fromisoformat(s)
            except Exception:
              return None

          current = load_json(dst) or {}

          # Deterministic normalization (avoids adding changing timestamps).
          normalized = dict(current)
          matches = normalized.get("matches", [])
          if isinstance(matches, list):
            now = dt.datetime.utcnow().replace(tzinfo=dt.timezone.utc)
            for m in matches:
              if isinstance(m, dict):
                status = str(m.get("status") or "").lower()
                kick   = from_iso(m.get("utcDate"))
                m["started"] = bool(kick and now >= kick)
                m["is_live"] = status in {"live", "inprogress", "in-progress"}

          if current == {} and not dst.exists():
            normalized = {"matches": []}

          new_text = json.dumps(normalized, separators=(",", ":"), sort_keys=True)
          old_text = dst.read_text(encoding="utf-8") if dst.exists() else None

          if new_text != old_text:
            dst.write_text(new_text, encoding="utf-8")
            changed = True
          else:
            changed = False

          # Signal to the workflow whether anything changed
          Path("/tmp/changed").write_text("1" if changed else "0")
          PY

          if [[ -f /tmp/changed && "$(cat /tmp/changed)" == "1" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & push (only if changed)
        if: steps.build.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/live_today.json
          git commit -m "Update live_today.json"
          git push
