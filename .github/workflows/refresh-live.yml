name: Refresh Live (Premier League) - LIST ONLY

on:
  schedule:
    # UTC schedules (note: UK = UTC in winter, UTC+1 in summer)
    # Slower overnight:
    - cron: "*/15 0-8 * * *"
    # Faster during typical match/football hours:
    - cron: "*/5 9-23 * * *"
  workflow_dispatch:
    inputs:
      only_missing:
        description: "Only write files if missing"
        type: boolean
        default: false
        required: false

permissions:
  contents: write

concurrency:
  group: pl-live-refresh
  cancel-in-progress: true

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      # Vars
      URL_LIVE: ${{ vars.URL_LIVE }} # e.g. https://v3.football.api-sports.io/fixtures?live=all
      LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}  # 39
      SEASON: ${{ vars.SEASON_PL }}        # 2025

      # Prefer direct API-Sports if present, else RapidAPI (keeps backwards compatibility)
      APISPORTS_KEY: ${{ secrets.APISPORTS_KEY }}
      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}

      # Quota
      DAILY_CAP: "7500"
      SOFT_CAP: "7200"

      # Heartbeat cadence (minutes) â€” prevents commit spam
      HEARTBEAT_EVERY_MIN: "30"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq and perl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq perl

      - name: Ensure folders
        run: |
          mkdir -p data/football/premier-league/live
          mkdir -p data/ops

      # -----------------------------
      # Quota state (daily reset)
      # -----------------------------
      - id: quota
        name: Quota state (load/reset per day)
        shell: bash
        run: |
          set -euo pipefail
          STATE="data/ops/live_usage.json"
          LONDON_DATE=$(TZ=Europe/London date +%F)

          CURR_DATE=""
          COUNT=0
          if [[ -f "$STATE" ]]; then
            CURR_DATE=$(jq -r '.date // ""' "$STATE")
            COUNT=$(jq -r '.count // 0' "$STATE")
          fi

          if [[ "$CURR_DATE" != "$LONDON_DATE" ]]; then
            COUNT=0
          fi

          jq -n --arg date "$LONDON_DATE" --argjson count "$COUNT" '{date:$date, count:$count}' > "$STATE"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - id: cap
        name: Quota guard (soft cap)
        shell: bash
        run: |
          set -euo pipefail
          STATE="data/ops/live_usage.json"
          COUNT=$(jq -r '.count // 0' "$STATE")
          SOFT=${SOFT_CAP}
          if (( COUNT >= SOFT )); then
            echo "over=true" >> "$GITHUB_OUTPUT"
          else
            echo "over=false" >> "$GITHUB_OUTPUT"
          fi

      # -----------------------------
      # Fetch LIVE LIST ONLY
      # -----------------------------
      - id: fetch
        name: Fetch live list (live_today.json only)
        if: steps.cap.outputs.over != 'true'
        shell: bash
        run: |
          set -euo pipefail

          ONLY_MISSING="${{ inputs.only_missing }}"
          if [[ -z "$ONLY_MISSING" ]]; then ONLY_MISSING="false"; fi

          STATE="data/ops/live_usage.json"
          LIVE_OUT="data/football/premier-league/live/live_today.json"
          HEARTBEAT="data/football/premier-league/live/heartbeat.json"

          COUNT=$(jq -r '.count // 0' "$STATE")
          DAILY=${DAILY_CAP}
          SOFT=${SOFT_CAP}

          CALLS_USED=0
          ANY_CHANGED="false"
          HEARTBEAT_CHANGED="false"

          # Build auth headers dynamically
          AUTH_HEADERS=()
          if [[ -n "${APISPORTS_KEY:-}" ]]; then
            echo "Auth mode: API-Sports (x-apisports-key)"
            AUTH_HEADERS+=("-H" "x-apisports-key: ${APISPORTS_KEY}")
            AUTH_HEADERS+=("-H" "accept: application/json")
          else
            echo "Auth mode: RapidAPI (x-rapidapi-key/host)"
            AUTH_HEADERS+=("-H" "x-rapidapi-key: ${RAPIDAPI_KEY}")
            AUTH_HEADERS+=("-H" "x-rapidapi-host: ${RAPIDAPI_HOST}")
            AUTH_HEADERS+=("-H" "accept: application/json")
          fi

          if [[ -z "${URL_LIVE:-}" ]]; then
            echo "URL_LIVE not set; nothing to do."
            echo "calls_used=0" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if (( COUNT + CALLS_USED >= DAILY )); then
            echo "Daily cap reached; skipping."
            echo "calls_used=0" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if (( COUNT + CALLS_USED >= SOFT )); then
            echo "Soft cap reached; skipping."
            echo "calls_used=0" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          FINAL_LIVE_URL="${URL_LIVE}&league=${LEAGUE_ID}&season=${SEASON}"
          echo "Fetching LIVE list: $FINAL_LIVE_URL"

          if [[ "$ONLY_MISSING" == "true" && -f "$LIVE_OUT" ]]; then
            echo "only_missing=true and live_today.json exists; skipping write."
            echo "calls_used=0" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          tmpbody="$(mktemp)"
          code=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$tmpbody" \
            "${AUTH_HEADERS[@]}" \
            "$FINAL_LIVE_URL" || true)

          CALLS_USED=$((CALLS_USED + 1))

          # Always update quota count even on failure (because it was a call)
          NEW_COUNT=$((COUNT + CALLS_USED))
          jq --argjson c "$NEW_COUNT" '.count = $c' "$STATE" > "$STATE.tmp" && mv "$STATE.tmp" "$STATE"

          if [[ "$code" != "200" ]]; then
            echo "WARN: live list HTTP error code=$code"
            rm -f "$tmpbody"
            echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ok=$(jq -r '(.response | type) == "array"' "$tmpbody" 2>/dev/null || echo "false")
          if [[ "$ok" != "true" ]]; then
            echo "WARN: live list payload missing .response array"
            rm -f "$tmpbody"
            echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "hb_changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ts=$(date -u +%FT%TZ)
          norm="$(mktemp)"
          jq --arg ts "$ts" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$tmpbody" > "$norm"
          rm -f "$tmpbody"

          mkdir -p "$(dirname "$LIVE_OUT")"
          if [[ ! -f "$LIVE_OUT" ]] || ! cmp -s "$norm" "$LIVE_OUT"; then
            mv "$norm" "$LIVE_OUT"
            ANY_CHANGED="true"
          else
            rm -f "$norm"
          fi

          # Lightweight console heartbeat (no commit)
          LIVE_COUNT=$(jq -r '.matches | length' "$LIVE_OUT" 2>/dev/null || echo "0")
          echo "LIVE_COUNT=$LIVE_COUNT lastUpdatedUTC=$ts quota=$NEW_COUNT"

          # Commit heartbeat only occasionally OR when live_today changes
          MINUTE=$(date -u +%M)
          MOD=$((10#$MINUTE % HEARTBEAT_EVERY_MIN))

          if [[ "$ANY_CHANGED" == "true" || "$MOD" -eq 0 ]]; then
            echo "{\"meta\":{\"lastRunUTC\":\"${ts}\"}}" > "$HEARTBEAT"
            HEARTBEAT_CHANGED="true"
          fi

          echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
          echo "changed=$ANY_CHANGED" >> "$GITHUB_OUTPUT"
          echo "hb_changed=$HEARTBEAT_CHANGED" >> "$GITHUB_OUTPUT"

      # -----------------------------
      # Commit & push only if something actually changed
      # (live_today changed OR quota file changed OR heartbeat throttled update)
      # -----------------------------
      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "pl-bot"
          git config user.email "pl-bot@users.noreply.github.com"

          git add data/football/premier-league/live/live_today.json || true
          git add data/ops/live_usage.json || true
          git add data/football/premier-league/live/heartbeat.json || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Live PL refresh (list only)" || true
          git push || true








# name: Refresh Live (Premier League) - LIST ONLY

# on:
#   schedule:
#     # GitHub cron is UTC
#     - cron: "*/5 * * * *"
#   workflow_dispatch:
#     inputs:
#       only_missing:
#         description: "Only write files if missing"
#         type: boolean
#         default: false
#         required: false

# permissions:
#   contents: write

# concurrency:
#   group: pl-live-refresh
#   cancel-in-progress: true

# jobs:
#   live:
#     runs-on: ubuntu-latest
#     timeout-minutes: 10

#     env:
#       # Vars
#       URL_LIVE: ${{ vars.URL_LIVE }} # e.g. https://v3.football.api-sports.io/fixtures?live=all
#       LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}  # 39
#       SEASON: ${{ vars.SEASON_PL }}        # 2025

#       # Prefer direct API-Sports if present, else RapidAPI (keeps backwards compatibility)
#       APISPORTS_KEY: ${{ secrets.APISPORTS_KEY }}
#       RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#       RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}

#       # Quota
#       DAILY_CAP: "7500"
#       SOFT_CAP: "7200"

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Install jq and perl
#         run: |
#           sudo apt-get update
#           sudo apt-get install -y jq perl

#       - name: Ensure folders
#         run: |
#           mkdir -p data/football/premier-league/live
#           mkdir -p data/ops

#       - name: Write heartbeat
#         shell: bash
#         run: |
#           set -euo pipefail
#           TS=$(date -u +%FT%TZ)
#           echo "{\"meta\":{\"lastRunUTC\":\"${TS}\"}}" > data/football/premier-league/live/heartbeat.json

#       # -----------------------------
#       # Quota state (daily reset)
#       # -----------------------------
#       - id: quota
#         name: Quota state (load/reset per day)
#         shell: bash
#         run: |
#           set -euo pipefail
#           STATE="data/ops/live_usage.json"
#           LONDON_DATE=$(TZ=Europe/London date +%F)

#           CURR_DATE=""
#           COUNT=0
#           if [[ -f "$STATE" ]]; then
#             CURR_DATE=$(jq -r '.date // ""' "$STATE")
#             COUNT=$(jq -r '.count // 0' "$STATE")
#           fi

#           if [[ "$CURR_DATE" != "$LONDON_DATE" ]]; then
#             COUNT=0
#           fi

#           jq -n --arg date "$LONDON_DATE" --argjson count "$COUNT" '{date:$date, count:$count}' > "$STATE"
#           echo "count=$COUNT" >> "$GITHUB_OUTPUT"

#       - id: cap
#         name: Quota guard (soft cap)
#         shell: bash
#         run: |
#           set -euo pipefail
#           STATE="data/ops/live_usage.json"
#           COUNT=$(jq -r '.count // 0' "$STATE")
#           SOFT=${SOFT_CAP}
#           if (( COUNT >= SOFT )); then
#             echo "over=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "over=false" >> "$GITHUB_OUTPUT"
#           fi

#       # -----------------------------
#       # Fetch LIVE LIST ONLY
#       # -----------------------------
#       - id: fetch
#         name: Fetch live list (live_today.json only)
#         if: steps.cap.outputs.over != 'true'
#         shell: bash
#         run: |
#           set -euo pipefail

#           ONLY_MISSING="${{ inputs.only_missing }}"
#           if [[ -z "$ONLY_MISSING" ]]; then ONLY_MISSING="false"; fi

#           STATE="data/ops/live_usage.json"
#           LIVE_OUT="data/football/premier-league/live/live_today.json"

#           COUNT=$(jq -r '.count // 0' "$STATE")
#           DAILY=${DAILY_CAP}
#           SOFT=${SOFT_CAP}

#           CALLS_USED=0
#           ANY_CHANGED="false"

#           # Build auth headers dynamically:
#           AUTH_HEADERS=()
#           if [[ -n "${APISPORTS_KEY:-}" ]]; then
#             echo "Auth mode: API-Sports (x-apisports-key)"
#             AUTH_HEADERS+=("-H" "x-apisports-key: ${APISPORTS_KEY}")
#             AUTH_HEADERS+=("-H" "accept: application/json")
#           else
#             echo "Auth mode: RapidAPI (x-rapidapi-key/host)"
#             AUTH_HEADERS+=("-H" "x-rapidapi-key: ${RAPIDAPI_KEY}")
#             AUTH_HEADERS+=("-H" "x-rapidapi-host: ${RAPIDAPI_HOST}")
#             AUTH_HEADERS+=("-H" "accept: application/json")
#           fi

#           if [[ -z "${URL_LIVE:-}" ]]; then
#             echo "URL_LIVE not set; nothing to do."
#             echo "calls_used=0" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           if (( COUNT + CALLS_USED >= DAILY )); then
#             echo "Daily cap reached; skipping."
#             echo "calls_used=0" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi
#           if (( COUNT + CALLS_USED >= SOFT )); then
#             echo "Soft cap reached; skipping."
#             echo "calls_used=0" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           FINAL_LIVE_URL="${URL_LIVE}&league=${LEAGUE_ID}&season=${SEASON}"
#           echo "Fetching LIVE list: $FINAL_LIVE_URL"

#           if [[ "$ONLY_MISSING" == "true" && -f "$LIVE_OUT" ]]; then
#             echo "only_missing=true and live_today.json exists; skipping write."
#             echo "calls_used=0" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           tmpbody="$(mktemp)"
#           code=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$tmpbody" \
#             "${AUTH_HEADERS[@]}" \
#             "$FINAL_LIVE_URL" || true)

#           CALLS_USED=$((CALLS_USED + 1))

#           if [[ "$code" != "200" ]]; then
#             echo "WARN: live list HTTP error code=$code"
#             rm -f "$tmpbody"
#             NEW_COUNT=$((COUNT + CALLS_USED))
#             jq --argjson c "$NEW_COUNT" '.count = $c' "$STATE" > "$STATE.tmp" && mv "$STATE.tmp" "$STATE"
#             echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           ok=$(jq -r '(.response | type) == "array"' "$tmpbody" 2>/dev/null || echo "false")
#           if [[ "$ok" != "true" ]]; then
#             echo "WARN: live list payload missing .response array"
#             rm -f "$tmpbody"
#             NEW_COUNT=$((COUNT + CALLS_USED))
#             jq --argjson c "$NEW_COUNT" '.count = $c' "$STATE" > "$STATE.tmp" && mv "$STATE.tmp" "$STATE"
#             echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           ts=$(date -u +%FT%TZ)
#           norm="$(mktemp)"
#           jq --arg ts "$ts" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$tmpbody" > "$norm"
#           rm -f "$tmpbody"

#           mkdir -p "$(dirname "$LIVE_OUT")"
#           if [[ ! -f "$LIVE_OUT" ]] || ! cmp -s "$norm" "$LIVE_OUT"; then
#             mv "$norm" "$LIVE_OUT"
#             ANY_CHANGED="true"
#           else
#             rm -f "$norm"
#           fi

#           NEW_COUNT=$((COUNT + CALLS_USED))
#           jq --argjson c "$NEW_COUNT" '.count = $c' "$STATE" > "$STATE.tmp" && mv "$STATE.tmp" "$STATE"

#           echo "calls_used=$CALLS_USED"
#           echo "New quota count=$NEW_COUNT"

#           echo "calls_used=$CALLS_USED" >> "$GITHUB_OUTPUT"
#           echo "changed=$ANY_CHANGED" >> "$GITHUB_OUTPUT"

#       # -----------------------------
#       # Commit & push only if live_today changed OR heartbeat/quota changed
#       # -----------------------------
#       - name: Commit & push if changed
#         shell: bash
#         run: |
#           set -euo pipefail
#           git config user.name "pl-bot"
#           git config user.email "pl-bot@users.noreply.github.com"

#           git add data/football/premier-league/live/heartbeat.json || true
#           git add data/football/premier-league/live/live_today.json || true
#           git add data/ops/live_usage.json || true

#           # Commit only if there are actual changes
#           if git diff --cached --quiet; then
#             echo "No changes to commit."
#             exit 0
#           fi

#           git commit -m "Live PL refresh (list only)" || true
#           git push || true


