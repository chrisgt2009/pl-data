name: Refresh PL data

on:
  schedule:
    # Sat/Sun match windows (UTC): every 15 minutes 10:00–22:59
    - cron: "*/15 10-22 * * 6,0"
    # Weekdays hourly
    - cron: "0 */1 * * 1-5"
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    env:
      FD_TOKEN: ${{ secrets.FD_API_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show runner time (UTC)
        run: date -u

      - name: Compute date window (UTC)
        id: dates
        run: |
          echo "TODAY=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "IN7=$(date -u -d '+7 days' +%Y-%m-%d)" >> $GITHUB_OUTPUT

      # ---------- Fetch raw data ----------
      - name: Fetch standings (PL)
        run: |
          curl -sS -H "X-Auth-Token: $FD_TOKEN" \
            "https://api.football-data.org/v4/competitions/PL/standings" \
            -o standings.raw.json

      - name: Fetch fixtures this week (PL)
        run: |
          curl -sS -H "X-Auth-Token: $FD_TOKEN" \
            "https://api.football-data.org/v4/competitions/PL/matches?dateFrom=${{ steps.dates.outputs.TODAY }}&dateTo=${{ steps.dates.outputs.IN7 }}" \
            -o fixtures_week.raw.json

      - name: Fetch today (PL)
        run: |
          curl -sS -H "X-Auth-Token: $FD_TOKEN" \
            "https://api.football-data.org/v4/competitions/PL/matches?dateFrom=${{ steps.dates.outputs.TODAY }}&dateTo=${{ steps.dates.outputs.TODAY }}" \
            -o today.raw.json

      # ---------- Process & slim ----------
      - name: Normalize / slim JSON
        run: |
          python - << 'PY'
          import json, datetime
          from datetime import timezone

          with open("standings.raw.json") as f: standings = json.load(f)
          with open("fixtures_week.raw.json") as f: fixtures_week = json.load(f)
          with open("today.raw.json") as f: today = json.load(f)

          # Standings (slim)
          standings_out = {
            "season": standings.get("season"),
            "standings": standings.get("standings"),
          }
          with open("data/standings.new.json", "w") as f:
            json.dump(standings_out, f, separators=(",", ":"), sort_keys=True)

          # Map teamId -> position
          pos = {}
          for st in standings.get("standings", []):
            for row in st.get("table", []):
              t = (row.get("team") or {})
              tid = t.get("id")
              if tid is not None:
                pos[tid] = row.get("position")

          # Fixtures (week)
          fw = []
          for m in fixtures_week.get("matches", []):
            fw.append({
              "id": m.get("id"),
              "utcDate": m.get("utcDate"),
              "status": m.get("status"),
              "matchday": m.get("matchday"),
              "homeTeam": m.get("homeTeam"),
              "awayTeam": m.get("awayTeam"),
              "score": (m.get("score") or {}).get("fullTime"),
              "competition": {
                "id": (m.get("competition") or {}).get("id"),
                "code": (m.get("competition") or {}).get("code"),
                "name": (m.get("competition") or {}).get("name"),
              },
            })
          fixtures_week_out = {
            "range": {"from": "${{ steps.dates.outputs.TODAY }}", "to": "${{ steps.dates.outputs.IN7 }}"},
            "matches": fw
          }
          with open("data/fixtures_week.new.json", "w") as f:
            json.dump(fixtures_week_out, f, separators=(",", ":"), sort_keys=True)

          # Live today
          def phase(status, utc_iso):
            try:
              kick = datetime.datetime.fromisoformat((utc_iso or "").replace("Z","+00:00"))
            except Exception:
              return None, ""
            now = datetime.datetime.now(timezone.utc)
            mins = int(max(0, (now - kick).total_seconds() // 60))
            if status == "SCHEDULED": return mins, "Today"
            if status == "IN_PLAY":
              if mins < 90: return mins, f"{mins}’"
              return mins, f"90+{mins-90}’"
            if status == "PAUSED": return 45, "Half-Time"
            if status == "FINISHED": return 90, "FT"
            return mins, status or ""

          live = []
          for m in today.get("matches", []):
            st = m.get("status"); utc = m.get("utcDate")
            mins, label = phase(st, utc)
            ft = (m.get("score") or {}).get("fullTime") or {}
            h = (m.get("homeTeam") or {}); a = (m.get("awayTeam") or {})
            live.append({
              "id": m.get("id"),
              "utcDate": utc,
              "status": st,
              "approxMinute": mins,
              "phase": label,
              "home": {"id": h.get("id"), "tla": h.get("tla"), "name": h.get("name"),
                       "score": ft.get("home"), "pos": pos.get(h.get("id"))},
              "away": {"id": a.get("id"), "tla": a.get("tla"), "name": a.get("name"),
                       "score": ft.get("away"), "pos": pos.get(a.get("id"))}
            })
          live_out = { "lastUpdatedUTC": datetime.datetime.now(timezone.utc).isoformat(),
                       "matches": live }
          with open("data/live_today.new.json", "w") as f:
            json.dump(live_out, f, separators=(",", ":"), sort_keys=True)

          # Meta
          meta = {"lastUpdatedUTC": datetime.datetime.now(timezone.utc).isoformat()}
          with open("data/meta.new.json", "w") as f:
            json.dump(meta, f, separators=(",", ":"), sort_keys=True)
          PY

      # ---------- Commit only if changed ----------
      - name: Commit if changed
        run: |
          set -e
          CHANGED=0
          for f in standings fixtures_week live_today meta; do
            if [ -f "data/$f.json" ] && [ -f "data/$f.new.json" ]; then
              if cmp -s "data/$f.new.json" "data/$f.json"; then
                echo "$f.json unchanged"
                rm -f "data/$f.new.json"
              else
                mv "data/$f.new.json" "data/$f.json"
                CHANGED=1
              fi
            else
              mv "data/$f.new.json" "data/$f.json"
              CHANGED=1
            fi
          done

          if [ $CHANGED -eq 1 ]; then
            git config user.name "pl-bot"
            git config user.email "pl-bot@users.noreply.github.com"
            git add data/*.json
            git commit -m "Update PL data $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push
          else
            echo "No changes to commit."
          fi
