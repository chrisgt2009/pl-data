name: Refresh Core (PL)

concurrency:
  group: pl-data-commit
  cancel-in-progress: false

on:
  workflow_dispatch:
  schedule:
    - cron: "5 * * * *"      # standings hourly at minute 5
    - cron: "0 */6 * * *"    # fixtures + scorers every 6 hours

permissions:
  contents: write

jobs:
  core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure folders (NEW STRUCTURE)
        run: |
          mkdir -p data/football/premier-league/core
          mkdir -p data/football/premier-league/fixtures
          mkdir -p data/football/premier-league/live

      # ---------------- FIXTURES (next 14 days) ----------------
      - id: fixtures
        name: Refresh upcoming fixtures (API-Football)
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_FIXTURES }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/fixtures/fixtures_week.json"
          TMPBODY="$(mktemp)"

          [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

          FROM=$(date -u +"%Y-%m-%d")
          TO=$(date -u -d "+14 days" +"%Y-%m-%d")

          FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}&from=${FROM}&to=${TO}"
          echo "Fetching fixtures: $FINAL_URL"

          CODE=$(curl -sS -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          if [[ "$CODE" != "200" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NORM=$(mktemp)
          jq '{matches: .response}' "$TMPBODY" > "$NORM"

          if ! cmp -s "$NORM" "$OUT"; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- STANDINGS ----------------
      - id: standings
        name: Refresh standings (API-Football)
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_STANDINGS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/standings.json"
          TMPBODY="$(mktemp)"

          [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "Fetching standings: $FINAL_URL"

          CODE=$(curl -sS -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          if [[ "$CODE" != "200" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NORM=$(mktemp)
          jq '{standings: .response}' "$TMPBODY" > "$NORM"

          if ! cmp -s "$NORM" "$OUT"; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- TOP SCORERS ----------------
      - id: scorers
        name: Refresh top scorers (API-Football)
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_SCORERS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/scorers.json"
          TMPBODY="$(mktemp)"

          [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "Fetching scorers: $FINAL_URL"

          CODE=$(curl -sS -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "code=$CODE" >> "$GITHUB_OUTPUT"
          if [[ "$CODE" != "200" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NORM=$(mktemp)
          jq '{scorers: .response}' "$TMPBODY" > "$NORM"

          if ! cmp -s "$NORM" "$OUT"; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- COMMIT ----------------
      - name: Commit & push
        if: steps.fixtures.outputs.changed == 'true' || steps.standings.outputs.changed == 'true' || steps.scorers.outputs.changed == 'true'
        run: |
          git config user.name "pl-bot"
          git config user.email "pl-bot@users.noreply.github.com"

          git add data/football/premier-league/core/*.json
          git add data/football/premier-league/fixtures/*.json

          git commit -m "Update core feeds (fixtures/standings/scorers)"
          git push
