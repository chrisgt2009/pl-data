name: Refresh Core (PL)

concurrency:
  group: pl-core-refresh
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Bypass reuse windows and broaden match window (manual runs)"
        type: boolean
        default: true
        required: false
      force_write_on_dispatch:
        description: "Force write outputs even if content unchanged (manual runs)"
        type: boolean
        default: true
        required: false
      force_matches_even_on_errors:
        description: "Write placeholder per-match files on 404/429 for visibility (manual runs)"
        type: boolean
        default: false
        required: false
      max_matches_per_run:
        description: "Max finished fixtures to process for match details this run (cap)"
        type: number
        default: 20
        required: false
      per_request_sleep_ms:
        description: "Sleep between match-detail requests (milliseconds)"
        type: number
        default: 200
        required: false
      matches_window_days:
        description: "Days window for match details (finished only). Use 7 scheduled, 30 manual if needed."
        type: number
        default: 7
        required: false

  schedule:
    # Standings/scorers/cards/assists every 3 hours
    - cron: "5 */3 * * *"
    # Fixtures twice a day (London morning and late evening) â€” split so github.event.schedule checks work
    - cron: "0 7 * * *"
    - cron: "0 23 * * *"

permissions:
  contents: write

jobs:
  core:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      FORCE_REFRESH: ${{ inputs.force_refresh && 'true' || 'false' }}
      FORCE_WRITE_ON_DISPATCH: ${{ inputs.force_write_on_dispatch && 'true' || 'false' }}
      FORCE_MATCHES_EVEN_ON_ERRORS: ${{ inputs.force_matches_even_on_errors && 'true' || 'false' }}
      MAX_MATCHES_PER_RUN: ${{ inputs.max_matches_per_run != '' && inputs.max_matches_per_run || 20 }}
      PER_REQUEST_SLEEP_MS: ${{ inputs.per_request_sleep_ms != '' && inputs.per_request_sleep_ms || 200 }}
      MATCHES_WINDOW_DAYS: ${{ inputs.matches_window_days != '' && inputs.matches_window_days || 7 }}

      RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}

      LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
      SEASON: ${{ vars.SEASON_PL }}

      URL_FIXTURES: ${{ vars.URL_FIXTURES }}
      URL_STANDINGS: ${{ vars.URL_STANDINGS }}
      URL_SCORERS: ${{ vars.URL_SCORERS }}
      URL_TOP_ASSISTS: ${{ vars.URL_TOP_ASSISTS }}
      URL_TOP_YELLOWS: ${{ vars.URL_TOP_YELLOWS }}
      URL_TOP_REDS: ${{ vars.URL_TOP_REDS }}

      # Exact API-Sports endpoints for match details (no vars required)
      EVENTS_BASE_URL: "https://v3.football.api-sports.io/fixtures/events?fixture="
      LINEUPS_BASE_URL: "https://v3.football.api-sports.io/fixtures/lineups?fixture="
      STATS_BASE_URL: "https://v3.football.api-sports.io/fixtures/statistics?fixture="

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq and perl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq perl

      - name: Ensure folders
        run: |
          mkdir -p data/football/premier-league/core
          mkdir -p data/football/premier-league/fixtures
          mkdir -p data/football/premier-league/matches
          mkdir -p data/ops

      - id: post_window
        name: Check post-window trigger
        shell: bash
        run: |
          set -euo pipefail
          FLAG="data/ops/post_window.json"
          NOW_TS=$(date -u +%s)

          if [[ -f "$FLAG" ]]; then
            TS=$(jq -r '.ts // 0' "$FLAG")
            if (( NOW_TS - TS <= 5400 )); then
              echo "Post-window flag present (age <= 90m)."
              echo "trigger=true" >> "$GITHUB_OUTPUT"
            else
              echo "Post-window flag present but too old."
              echo "trigger=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No post-window flag found."
            echo "trigger=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- FIXTURES (next 14 days) ----------------
      - id: fixtures
        name: Refresh upcoming fixtures (next 14 days)
        if: github.event.schedule == '0 7 * * *' || github.event.schedule == '0 23 * * *' || github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/fixtures/fixtures_week.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${URL_FIXTURES:-}" ]]; then
            echo "fixtures: URL_FIXTURES not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "fixtures: credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          REUSE_MAX_AGE_MIN=60
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "fixtures: Reusing (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          FROM=$(date -u +"%Y-%m-%d")
          TO=$(date -u -d "+14 days" +"%Y-%m-%d")
          FINAL_URL="${URL_FIXTURES}&league=${LEAGUE_ID}&season=${SEASON}&from=${FROM}&to=${TO}"
          echo "fixtures: Fetching $FINAL_URL"

          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then
            echo "fixtures: Non-200 ($CODE)."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "fixtures: Bad payload."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- STANDINGS ----------------
      - id: standings
        name: Refresh standings
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/core/standings.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${URL_STANDINGS:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_STANDINGS}&season=${SEASON}&league=${LEAGUE_ID}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{standings: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- TOP SCORERS ----------------
      - id: scorers
        name: Refresh top scorers
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/core/scorers.json"
          TMPBODY="$(mktemp)"
          if [[ -z "${URL_SCORERS:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_SCORERS}&season=${SEASON}&league=${LEAGUE_ID}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{scorers: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- TOP ASSISTS ----------------
      - id: assists
        name: Refresh top assists
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/core/assists.json"
          TMPBODY="$(mktemp)"
          if [[ -z "${URL_TOP_ASSISTS:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_TOP_ASSISTS}&season=${SEASON}&league=${LEAGUE_ID}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{assists: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- TOP YELLOW CARDS ----------------
      - id: cards_yellow
        name: Refresh top yellow cards
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/core/cards_yellow.json"
          TMPBODY="$(mktemp)"
          if [[ -z "${URL_TOP_YELLOWS:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_TOP_YELLOWS}&season=${SEASON}&league=${LEAGUE_ID}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{cards_yellow: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- TOP RED CARDS ----------------
      - id: cards_red
        name: Refresh top red cards
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/core/cards_red.json"
          TMPBODY="$(mktemp)"
          if [[ -z "${URL_TOP_REDS:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_TOP_REDS}&season=${SEASON}&league=${LEAGUE_ID}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{cards_red: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- SEASON FIXTURES (full season) ----------------
      - id: fixtures_season
        name: Refresh full season fixtures
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail
          OUT="data/football/premier-league/fixtures/fixtures_season.json"
          TMPBODY="$(mktemp)"
          if [[ -z "${URL_FIXTURES:-}" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          REUSE_MAX_AGE_MIN=720
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          fi

          FINAL_URL="${URL_FIXTURES}&league=${LEAGUE_ID}&season=${SEASON}"
          CODE=$(curl -sS --retry 3 --retry-delay 2 --retry-all-errors \
            --connect-timeout 5 --max-time 35 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          if [[ "$CODE" != "200" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi
          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY"); if [[ "$OK" != "true" ]]; then echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then mv "$NORM" "$OUT"; echo "changed=true" >> "$GITHUB_OUTPUT"; else echo "changed=false" >> "$GITHUB_OUTPUT"; fi
          fi

      # ---------------- MATCH DETAILS (FINISHED ONLY): timeline + lineups + stats ----------------
      - id: match_details
        name: Refresh match details for finished fixtures (events + lineups + stats)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        run: |
          set -euo pipefail

          CHANGED=false
          NOW=$(date -u +%s)
          WINDOW_SEC=$((MATCHES_WINDOW_DAYS*24*3600))

          # Helper: millisecond sleep using perl; fallback to seconds
          ms_sleep() {
            local ms="$1"
            if command -v perl >/dev/null 2>&1; then
              perl -e "select(undef, undef, undef, ${ms}/1000.0);"
            else
              local sec=$(( (ms + 999) / 1000 ))
              sleep "${sec}"
            fi
          }

          # Finished-only statuses to avoid duplicating Live workflow
          is_finished_status() {
            case "$1" in
              FT|AET|PEN) return 0 ;;
              *) return 1 ;;
            esac
          }

          # Collect candidates from fixtures sources
          declare -a SOURCES=(
            "data/football/premier-league/fixtures/fixtures_week.json"
            "data/football/premier-league/fixtures/fixtures_season.json"
          )

          TMPFIX="$(mktemp)"
          > "$TMPFIX"

          FOUND=false
          for SRC in "${SOURCES[@]}"; do
            if [[ -f "$SRC" ]]; then
              FOUND=true
              jq -r '.matches[]? | [.fixture.id, .fixture.date, .fixture.status.short] | @tsv' "$SRC" 2>/dev/null || true
            fi
          done | sort -u > "$TMPFIX"

          if [[ "$FOUND" != "true" ]] || [[ ! -s "$TMPFIX" ]]; then
            echo "match_details: No fixtures sources present or empty."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TMP_ELIG="$(mktemp)"
          > "$TMP_ELIG"

          while IFS=$'\t' read -r FID FDATE STATUS; do
            [[ -z "$FID" ]] && continue
            STATUS_UP=$(echo "$STATUS" | tr '[:lower:]' '[:upper:]')
            if ! is_finished_status "$STATUS_UP"; then
              continue
            fi

            FTS=0
            if [[ -n "$FDATE" ]]; then
              FTS=$(date -u -d "$FDATE" +%s 2>/dev/null || echo "0")
            fi
            if (( FTS > 0 )); then
              AGE=$(( NOW - FTS ))
              if (( AGE > WINDOW_SEC )); then
                continue
              fi
            fi

            echo -e "${FTS}\t${FID}\t${FDATE}\t${STATUS_UP}" >> "$TMP_ELIG"
          done < "$TMPFIX"

          if [[ ! -s "$TMP_ELIG" ]]; then
            echo "match_details: No eligible finished fixtures within window."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TMP_BATCH="$(mktemp)"
          sort -nr "$TMP_ELIG" | head -n "${MAX_MATCHES_PER_RUN}" > "$TMP_BATCH"
          COUNT=$(wc -l < "$TMP_BATCH" | tr -d ' ')
          echo "match_details: Processing up to ${COUNT} finished fixtures (cap=${MAX_MATCHES_PER_RUN})."

          fetch_one() {
            local url="$1"
            local out="$2"

            local tmp="$(mktemp)"
            local attempt=1
            local code=""

            # up to 3 attempts on 429
            while (( attempt <= 3 )); do
              code=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$tmp" \
                -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
                -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
                "$url" || true)

              if [[ "$code" == "429" && "$attempt" -lt 3 ]]; then
                backoff=$((2**attempt))
                echo "429 -> backoff ${backoff}s (attempt ${attempt})"
                sleep "${backoff}"
                attempt=$((attempt+1))
                continue
              fi
              break
            done

            if [[ "$code" != "200" ]]; then
              rm -f "$tmp"
              return 2
            fi

            local ok
            ok=$(jq -r '(.response | type) == "array"' "$tmp" 2>/dev/null || echo "false")
            if [[ "$ok" != "true" ]]; then
              rm -f "$tmp"
              return 3
            fi

            local ts norm
            ts=$(date -u +%FT%TZ)
            norm="$(mktemp)"

            # Wrap already-normalized per file type
            jq --arg ts "$ts" '{data: .response, meta: { lastUpdatedUTC: $ts }}' "$tmp" > "$norm"

            mkdir -p "$(dirname "$out")"
            if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
              mv "$norm" "$out"
              CHANGED=true
            else
              if [[ ! -f "$out" ]] || ! cmp -s "$norm" "$out"; then
                mv "$norm" "$out"
                CHANGED=true
              else
                rm -f "$norm"
              fi
            fi

            rm -f "$tmp"
            return 0
          }

          PROCESSED=0
          while IFS=$'\t' read -r FTS FID FDATE STATUS; do
            # Per-fixture folder
            DIR="data/football/premier-league/matches/${FID}"
            EVT_OUT="${DIR}/events.json"
            LUP_OUT="${DIR}/lineups.json"
            STA_OUT="${DIR}/stats.json"

            echo "match_details: fixture=$FID status=$STATUS date=$FDATE"

            # Pace between requests (applies to each call)
            if [[ "${PER_REQUEST_SLEEP_MS}" -gt 0 ]]; then ms_sleep "${PER_REQUEST_SLEEP_MS}"; fi
            if ! fetch_one "${EVENTS_BASE_URL}${FID}" "$EVT_OUT"; then
              if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_MATCHES_EVEN_ON_ERRORS}" == "true" ]]; then
                TS=$(date -u +%FT%TZ)
                mkdir -p "$DIR"
                echo "{\"data\":[],\"meta\":{\"lastUpdatedUTC\":\"${TS}\",\"note\":\"placeholder due to events fetch error\"}}" > "$EVT_OUT"
                CHANGED=true
              fi
            fi

            if [[ "${PER_REQUEST_SLEEP_MS}" -gt 0 ]]; then ms_sleep "${PER_REQUEST_SLEEP_MS}"; fi
            if ! fetch_one "${LINEUPS_BASE_URL}${FID}" "$LUP_OUT"; then
              if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_MATCHES_EVEN_ON_ERRORS}" == "true" ]]; then
                TS=$(date -u +%FT%TZ)
                mkdir -p "$DIR"
                echo "{\"data\":[],\"meta\":{\"lastUpdatedUTC\":\"${TS}\",\"note\":\"placeholder due to lineups fetch error\"}}" > "$LUP_OUT"
                CHANGED=true
              fi
            fi

            if [[ "${PER_REQUEST_SLEEP_MS}" -gt 0 ]]; then ms_sleep "${PER_REQUEST_SLEEP_MS}"; fi
            if ! fetch_one "${STATS_BASE_URL}${FID}" "$STA_OUT"; then
              if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_MATCHES_EVEN_ON_ERRORS}" == "true" ]]; then
                TS=$(date -u +%FT%TZ)
                mkdir -p "$DIR"
                echo "{\"data\":[],\"meta\":{\"lastUpdatedUTC\":\"${TS}\",\"note\":\"placeholder due to stats fetch error\"}}" > "$STA_OUT"
                CHANGED=true
              fi
            fi

            PROCESSED=$((PROCESSED+1))
          done < "$TMP_BATCH"

          echo "match_details: Processed fixtures: $PROCESSED"
          echo "changed=${CHANGED}" >> "$GITHUB_OUTPUT"

      # ---------------- OPS SUMMARY ----------------
      - id: ops_summary
        name: Write ops summary
        shell: bash
        run: |
          set -euo pipefail
          TS=$(date -u +%FT%TZ)
          jq -n \
            --arg ts "$TS" \
            --arg force "${FORCE_REFRESH}" \
            --arg window "${MATCHES_WINDOW_DAYS}" \
            --arg max "${MAX_MATCHES_PER_RUN}" \
            '{
              lastRunUTC: $ts,
              forceRefresh: $force,
              matchesWindowDays: ($window|tonumber),
              maxMatchesPerRun: ($max|tonumber)
            }' > data/ops/core_last_run.json

      - name: Commit & push
        if: steps.fixtures.outputs.changed == 'true' ||
            steps.standings.outputs.changed == 'true' ||
            steps.scorers.outputs.changed == 'true' ||
            steps.assists.outputs.changed == 'true' ||
            steps.cards_yellow.outputs.changed == 'true' ||
            steps.cards_red.outputs.changed == 'true' ||
            steps.fixtures_season.outputs.changed == 'true' ||
            steps.match_details.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "pl-bot"
          git config user.email "pl-bot@users.noreply.github.com"

          git add data/football/premier-league/core/*.json || true
          git add data/football/premier-league/fixtures/*.json || true
          git add data/football/premier-league/matches/** || true
          git add data/ops/core_last_run.json || true

          git commit -m "Update core feeds + finished match details (events/lineups/stats)" || true
          git push || true
