name: Refresh Core (PL)

concurrency:
  group: pl-data-commit
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      force_refresh:
        description: "Bypass reuse windows and broaden event window (manual runs)"
        type: boolean
        default: true
        required: false
      force_write_on_dispatch:
        description: "Force write outputs even if content unchanged (manual runs)"
        type: boolean
        default: true
        required: false
      force_events_even_on_errors:
        description: "Write placeholder per-match files on 404/429 for visibility (manual runs)"
        type: boolean
        default: true
        required: false
  schedule:
    # Standings/scorers/cards/assists every 3 hours
    - cron: "5 */3 * * *"
    # Fixtures twice a day (London morning and late evening)
    - cron: "0 7,23 * * *"

permissions:
  contents: write

jobs:
  core:
    runs-on: ubuntu-latest
    env:
      FORCE_REFRESH: ${{ inputs.force_refresh && 'true' || 'false' }}
      FORCE_WRITE_ON_DISPATCH: ${{ inputs.force_write_on_dispatch && 'true' || 'false' }}
      FORCE_EVENTS_EVEN_ON_ERRORS: ${{ inputs.force_events_even_on_errors && 'true' || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Ensure folders
        run: |
          mkdir -p data/football/premier-league/core
          mkdir -p data/football/premier-league/fixtures
          mkdir -p data/football/premier-league/live
          mkdir -p data/football/premier-league/matches
          mkdir -p data/ops

      - name: Locate workflow and list tree
        run: |
          echo "Workflow path: .github/workflows/refresh_core_pl.yml"
          echo "FORCE_REFRESH=${FORCE_REFRESH}"
          echo "FORCE_WRITE_ON_DISPATCH=${FORCE_WRITE_ON_DISPATCH}"
          echo "FORCE_EVENTS_EVEN_ON_ERRORS=${FORCE_EVENTS_EVEN_ON_ERRORS}"
          ls -la .github/workflows || true
          find data -maxdepth 3 -type d -print || true

      - id: post_window
        name: Check post-window trigger
        shell: bash
        run: |
          set -euo pipefail
          FLAG="data/ops/post_window.json"
          NOW_TS=$(date -u +%s)

          if [[ -f "$FLAG" ]]; then
            TS=$(jq -r '.ts // 0' "$FLAG")
            if (( NOW_TS - TS <= 5400 )); then
              echo "Post-window flag present (age <= 90m). Will trigger post-window guarded steps."
              echo "trigger=true" >> "$GITHUB_OUTPUT"
            else
              echo "Post-window flag present but too old. Skipping post-window guarded steps."
              echo "trigger=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No post-window flag found. Post-window guarded steps will only run via schedule/dispatch."
            echo "trigger=false" >> "$GITHUB_OUTPUT"
          fi

      # ---------------- FIXTURES (next 14 days) ----------------
      - id: fixtures
        name: Refresh upcoming fixtures (API-Football)
        if: github.event.schedule == '0 7 * * *' || github.event.schedule == '0 23 * * *' || github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_FIXTURES }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/fixtures/fixtures_week.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "fixtures: URL_FIXTURES is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "fixtures: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=60
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "fixtures: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "fixtures: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "fixtures: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FROM=$(date -u +"%Y-%m-%d")
          TO=$(date -u -d "+14 days" +"%Y-%m-%d")

          FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}&from=${FROM}&to=${TO}"
          echo "fixtures: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "fixtures: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "fixtures: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "fixtures: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "fixtures: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "fixtures: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "fixtures: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- STANDINGS ----------------
      - id: standings
        name: Refresh standings (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_STANDINGS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/standings.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "standings: URL_STANDINGS is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "standings: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "standings: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "standings: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "standings: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "standings: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "standings: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "standings: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "standings: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{standings: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "standings: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "standings: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "standings: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- TOP SCORERS ----------------
      - id: scorers
        name: Refresh top scorers (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_SCORERS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/scorers.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "scorers: URL_SCORERS is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "scorers: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "scorers: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "scorers: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "scorers: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "scorers: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "scorers: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "scorers: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "scorers: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{scorers: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "scorers: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "scorers: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "scorers: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- TOP ASSISTS ----------------
      - id: assists
        name: Refresh top assists (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_TOP_ASSISTS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/assists.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "assists: URL_TOP_ASSISTS is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "assists: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "assists: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "assists: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "assists: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "assists: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "assists: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "assists: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "assists: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{assists: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "assists: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "assists: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "assists: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- TOP YELLOW CARDS ----------------
      - id: cards_yellow
        name: Refresh top yellow cards (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_TOP_YELLOWS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/cards_yellow.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "cards_yellow: URL_TOP_YELLOWS is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "cards_yellow: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "cards_yellow: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "cards_yellow: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "cards_yellow: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "cards_yellow: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "cards_yellow: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "cards_yellow: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "cards_yellow: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{cards_yellow: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "cards_yellow: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "cards_yellow: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "cards_yellow: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- TOP RED CARDS ----------------
      - id: cards_red
        name: Refresh top red cards (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_TOP_REDS }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/core/cards_red.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "cards_red: URL_TOP_REDS is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "cards_red: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=180
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "cards_red: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "cards_red: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "cards_red: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
          echo "cards_red: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "cards_red: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "cards_red: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "cards_red: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{cards_red: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "cards_red: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "cards_red: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "cards_red: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- SEASON FIXTURES (full season) ----------------
      - id: fixtures_season
        name: Refresh full season fixtures (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          BASE_URL: ${{ vars.URL_FIXTURES }}
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
          LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
          SEASON: ${{ vars.SEASON_PL }}
        run: |
          set -euo pipefail

          OUT="data/football/premier-league/fixtures/fixtures_season.json"
          TMPBODY="$(mktemp)"

          if [[ -z "${BASE_URL:-}" ]]; then
            echo "fixtures_season: URL_FIXTURES is not set. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "fixtures_season: RAPIDAPI credentials missing. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Reuse if recent unless FORCE_REFRESH
          REUSE_MAX_AGE_MIN=720
          if [[ "${FORCE_REFRESH}" != "true" ]] && [[ -f "$OUT" ]]; then
            MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
            NOW=$(date +%s)
            AGE_MIN=$(( (NOW - MTIME) / 60 ))
            if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
              echo "fixtures_season: Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m). No fetch."
              echo "changed=false" >> "$GITHUB_OUTPUT"
              exit 0
            else
              echo "fixtures_season: Existing data is ${AGE_MIN}m old. Will fetch."
            fi
          else
            echo "fixtures_season: FORCE_REFRESH=${FORCE_REFRESH}. Skipping reuse window check. Will fetch."
          fi

          FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}"
          echo "fixtures_season: Fetching $FINAL_URL"

          CODE=$(curl -sS --connect-timeout 5 --max-time 35 -w "%{http_code}" -o "$TMPBODY" \
            -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
            -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
            "$FINAL_URL" || true)

          echo "fixtures_season: http code=$CODE"
          if [[ "$CODE" != "200" ]]; then
            echo "fixtures_season: Non-200 ($CODE). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
          if [[ "$OK" != "true" ]]; then
            echo "fixtures_season: Unexpected payload (.response not array). Skipping write."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TS=$(date -u +%FT%TZ)
          NORM=$(mktemp)
          jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

          if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
            echo "fixtures_season: FORCE write."
            mv "$NORM" "$OUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            if ! cmp -s "$NORM" "$OUT"; then
              echo "fixtures_season: Content changed. Updating $OUT."
              mv "$NORM" "$OUT"
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "fixtures_season: No content change. Skipping commit."
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
          fi

      # ---------------- MATCH EVENTS (cards per fixture) ----------------
      - id: match_events
        name: Refresh match events (API-Football)
        if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
        shell: bash
        env:
          EVENTS_BASE_URL: ${{ vars.URL_EVENTS }} # e.g. https://api-football-v1.p.rapidapi.com/v3/fixtures/events?fixture=
          RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
          RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
        run: |
          set -euo pipefail

          CHANGED=false

          if [[ -z "${EVENTS_BASE_URL:-}" ]]; then
            echo "match_events: URL_EVENTS is not set. Skipping all event fetches."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [[ -z "${RAPIDAPI_KEY:-}" || -z "${RAPIDAPI_HOST:-}" ]]; then
            echo "match_events: RAPIDAPI credentials missing. Skipping all event fetches."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          declare -a SOURCES=(
            "data/football/premier-league/fixtures/fixtures_week.json"
            "data/football/premier-league/fixtures/fixtures_season.json"
          )

          FOUND_SOURCE=false
          for SRC in "${SOURCES[@]}"; do
            if [[ -f "$SRC" ]]; then
              echo "match_events: Found source $SRC"
              FOUND_SOURCE=true
            else
              echo "match_events: Source missing $SRC (ok if not yet generated)"
            fi
          done
          if [[ "$FOUND_SOURCE" == "false" ]]; then
            echo "match_events: No source fixtures files present. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          NOW=$(date -u +%s)
          WINDOW_SEC=$((7*24*3600))
          if [[ "${FORCE_REFRESH}" == "true" ]]; then
            WINDOW_SEC=$((30*24*3600))
            echo "match_events: FORCE_REFRESH=true, expanding window to $((WINDOW_SEC/86400)) days."
          fi
          echo "match_events: Considering finished fixtures within the last $((WINDOW_SEC/86400)) days."

          TMPFIX="$(mktemp)"
          > "$TMPFIX"

          for SRC in "${SOURCES[@]}"; do
            if [[ -f "$SRC" ]]; then
              jq -r '.matches[]? | [.fixture.id, .fixture.date, .fixture.status.short] | @tsv' "$SRC" 2>/dev/null || true
            fi
          done | sort -u > "$TMPFIX"

          if [[ ! -s "$TMPFIX" ]]; then
            echo "match_events: No fixtures found in sources. Skipping."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          PROCESSED=0
          ELIGIBLE=0

          while IFS=$'\t' read -r FID FDATE STATUS; do
            [[ -z "$FID" ]] && continue

            case "$STATUS" in
              FT|AET|PEN) ;;
              *)
                echo "match_events: Fixture $FID skipped (status=$STATUS not finished)."
                continue
                ;;
            esac

            INCLUDE=1
            if [[ -n "$FDATE" ]]; then
              FTS=$(date -u -d "$FDATE" +%s 2>/dev/null || echo "0")
              if [[ "$FTS" != "0" ]]; then
                AGE=$(( NOW - FTS ))
                if (( AGE > WINDOW_SEC )); then
                  INCLUDE=0
                  echo "match_events: Fixture $FID skipped (older than window)."
                fi
              else
                echo "match_events: Fixture $FID date parse failed; including by default."
              fi
            fi
            [[ "$INCLUDE" -eq 0 ]] && continue

            ELIGIBLE=$((ELIGIBLE+1))

            OUT="data/football/premier-league/matches/${FID}.json"
            TMPEVT="$(mktemp)"

            FINAL_URL="${EVENTS_BASE_URL}${FID}"
            echo "match_events: Fetching events for fixture=$FID: $FINAL_URL"

            # Try once; if 429, sleep briefly and try once more
            CODE=$(curl -sS --connect-timeout 5 --max-time 20 -w "%{http_code}" -o "$TMPEVT" \
              -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
              -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
              "$FINAL_URL" || true)

            if [[ "$CODE" == "429" ]]; then
              echo "match_events: Fixture $FID hit rate limit (429). Backing off 2s and retrying once."
              sleep 2
              CODE=$(curl -sS --connect-timeout 5 --max-time 20 -w "%{http_code}" -o "$TMPEVT" \
                -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
                -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
                "$FINAL_URL" || true)
            fi

            if [[ "$CODE" != "200" ]]; then
              echo "match_events: Fixture $FID skipped (HTTP $CODE)."
              if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_EVENTS_EVEN_ON_ERRORS}" == "true" ]]; then
                echo "match_events: FORCE_EVENTS_EVEN_ON_ERRORS=true: writing placeholder for $FID"
                mkdir -p "$(dirname "$OUT")"
                TS=$(date -u +%FT%TZ)
                echo "{\"events\":[],\"meta\":{\"lastUpdatedUTC\":\"${TS}\",\"note\":\"placeholder due to HTTP ${CODE}\"}}" > "$OUT"
                CHANGED=true
                PROCESSED=$((PROCESSED+1))
              fi
              continue
            fi

            OK=$(jq -r '(.response | type) == "array"' "$TMPEVT" 2>/dev/null || echo "false")
            if [[ "$OK" != "true" ]]; then
              echo "match_events: Fixture $FID skipped (unexpected payload, .response not array)."
              if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_EVENTS_EVEN_ON_ERRORS}" == "true" ]]; then
                echo "match_events: FORCE_EVENTS_EVEN_ON_ERRORS=true: writing placeholder for $FID (bad payload)"
                mkdir -p "$(dirname "$OUT")"
                TS=$(date -u +%FT%TZ)
                echo "{\"events\":[],\"meta\":{\"lastUpdatedUTC\":\"${TS}\",\"note\":\"placeholder due to unexpected payload\"}}" > "$OUT"
                CHANGED=true
                PROCESSED=$((PROCESSED+1))
              fi
              continue
            fi

            TS=$(date -u +%FT%TZ)
            NORM="$(mktemp)"
            jq --arg ts "$TS" '{events: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPEVT" > "$NORM"

            if [[ "${FORCE_REFRESH}" == "true" && "${FORCE_WRITE_ON_DISPATCH}" == "true" ]]; then
              mkdir -p "$(dirname "$OUT")"
              mv "$NORM" "$OUT"
              CHANGED=true
              PROCESSED=$((PROCESSED+1))
              echo "match_events: FORCE write/updated $OUT"
            else
              if [[ ! -f "$OUT" ]] || ! cmp -s "$NORM" "$OUT"; then
                mkdir -p "$(dirname "$OUT")"
                mv "$NORM" "$OUT"
                CHANGED=true
                PROCESSED=$((PROCESSED+1))
                echo "match_events: Wrote/updated $OUT"
              else
                echo "match_events: No change for $OUT"
              fi
            fi
          done < "$TMPFIX"

          echo "match_events: Eligible finished fixtures in window: $ELIGIBLE"
          echo "match_events: Files written/updated: $PROCESSED"

          if [[ "$CHANGED" == "true" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & push
        if: steps.fixtures.outputs.changed == 'true' || steps.standings.outputs.changed == 'true' || steps.scorers.outputs.changed == 'true' || steps.assists.outputs.changed == 'true' || steps.cards_yellow.outputs.changed == 'true' || steps.cards_red.outputs.changed == 'true' || steps.fixtures_season.outputs.changed == 'true' || steps.match_events.outputs.changed == 'true'
        run: |
          git config user.name "pl-bot"
          git config user.email "pl-bot@users.noreply.github.com"

          git add data/football/premier-league/core/*.json || true
          git add data/football/premier-league/fixtures/*.json || true
          git add data/football/premier-league/matches/*.json || true
          git add data/football/premier-league/live/*.json || true

          git commit -m "Update core feeds (fixtures/standings/scorers/assists/cards/season/events)"
          git push


# name: Refresh Core (PL)

# concurrency:
#   group: pl-data-commit
#   cancel-in-progress: false

# on:
#   workflow_dispatch:
#   schedule:
#     # Standings/scorers/cards/assists every 3 hours
#     - cron: "5 */3 * * *"
#     # Fixtures twice a day (London morning and late evening)
#     - cron: "0 7,23 * * *"

# permissions:
#   contents: write

# jobs:
#   core:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Install jq
#         run: sudo apt-get update && sudo apt-get install -y jq

#       - name: Ensure folders
#         run: |
#           mkdir -p data/football/premier-league/core
#           mkdir -p data/football/premier-league/fixtures
#           mkdir -p data/football/premier-league/live
#           mkdir -p data/ops

#       - name: Ensure extra folders
#         run: |
#           mkdir -p data/football/premier-league/teams
#           mkdir -p data/football/premier-league/matches
#           mkdir -p data/football/premier-league/media

#       - name: Locate workflow and list tree
#         run: |
#           echo "Workflow path: .github/workflows/refresh_core_pl.yml"
#           ls -la .github/workflows || true
#           find data -maxdepth 3 -type d -print || true

#       - id: post_window
#         name: Check post-window trigger
#         shell: bash
#         run: |
#           set -euo pipefail
#           FLAG="data/ops/post_window.json"
#           NOW_TS=$(date -u +%s)

#           if [[ -f "$FLAG" ]]; then
#             TS=$(jq -r '.ts // 0' "$FLAG")
#             if (( NOW_TS - TS <= 5400 )); then
#               echo "trigger=true" >> "$GITHUB_OUTPUT"
#             else
#               echo "trigger=false" >> "$GITHUB_OUTPUT"
#             fi
#           else
#             echo "trigger=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- FIXTURES (next 14 days) ----------------
#       - id: fixtures
#         name: Refresh upcoming fixtures (API-Football)
#         if: github.event.schedule == '0 7 * * *' || github.event.schedule == '0 23 * * *' || github.event_name == 'workflow_dispatch'
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_FIXTURES }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/fixtures/fixtures_week.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (60 min)
#           REUSE_MAX_AGE_MIN=60
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FROM=$(date -u +"%Y-%m-%d")
#           TO=$(date -u -d "+14 days" +"%Y-%m-%d")

#           FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}&from=${FROM}&to=${TO}"
#           echo "Fetching fixtures: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- STANDINGS ----------------
#       - id: standings
#         name: Refresh standings (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_STANDINGS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/standings.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (180 min)
#           REUSE_MAX_AGE_MIN=180
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
#           echo "Fetching standings: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{standings: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- TOP SCORERS ----------------
#       - id: scorers
#         name: Refresh top scorers (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_SCORERS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/scorers.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (180 min)
#           REUSE_MAX_AGE_MIN=180
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
#           echo "Fetching scorers: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{scorers: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- TOP ASSISTS ----------------
#       - id: assists
#         name: Refresh top assists (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_TOP_ASSISTS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/assists.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (180 min)
#           REUSE_MAX_AGE_MIN=180
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
#           echo "Fetching top assists: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{assists: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- TOP YELLOW CARDS ----------------
#       - id: cards_yellow
#         name: Refresh top yellow cards (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_TOP_YELLOWS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/cards_yellow.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (180 min)
#           REUSE_MAX_AGE_MIN=180
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
#           echo "Fetching yellow cards leaderboard: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{cards_yellow: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- TOP RED CARDS ----------------
#       - id: cards_red
#         name: Refresh top red cards (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_TOP_REDS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/cards_red.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (180 min)
#           REUSE_MAX_AGE_MIN=180
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&season=${SEASON}&league=${LEAGUE_ID}"
#           echo "Fetching red cards leaderboard: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{cards_red: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- SEASON FIXTURES (full season) ----------------
#       - id: fixtures_season
#         name: Refresh full season fixtures (API-Football)
#         if: steps.post_window.outputs.trigger == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_FIXTURES }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/fixtures/fixtures_season.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           # Reuse if recent (720 min = 12h)
#           REUSE_MAX_AGE_MIN=720
#           if [[ -f "$OUT" ]]; then
#             MTIME=$(stat -c %Y "$OUT" 2>/dev/null || stat -f %m "$OUT" 2>/dev/null || echo 0)
#             NOW=$(date +%s)
#             AGE_MIN=$(( (NOW - MTIME) / 60 ))
#             if (( AGE_MIN < REUSE_MAX_AGE_MIN )); then
#               echo "Reusing existing $OUT (age ${AGE_MIN}m < ${REUSE_MAX_AGE_MIN}m)"
#               echo "changed=false" >> "$GITHUB_OUTPUT"
#               exit 0
#             fi
#           fi

#           FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}"
#           echo "Fetching full season fixtures: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 35 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{matches: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- TEAMS ----------------
#       - id: teams
#         name: Refresh teams (API-Football)
#         if: github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_TEAMS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/teams.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}"
#           echo "Fetching teams: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{teams: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- VENUES ----------------
#       - id: venues
#         name: Refresh venues (API-Football)
#         if: github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_VENUES }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/venues.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}"
#           echo "Fetching venues: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{venues: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       # ---------------- ROUNDS ----------------
#       - id: rounds
#         name: Refresh rounds (API-Football)
#         if: github.event_name == 'workflow_dispatch' || startsWith(github.event.schedule, '5 ')
#         shell: bash
#         env:
#           BASE_URL: ${{ vars.URL_ROUNDS }}
#           RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
#           RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
#           LEAGUE_ID: ${{ vars.LEAGUE_ID_PL }}
#           SEASON: ${{ vars.SEASON_PL }}
#         run: |
#           set -euo pipefail

#           OUT="data/football/premier-league/core/rounds.json"
#           TMPBODY="$(mktemp)"

#           [[ -z "${BASE_URL:-}" ]] && { echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

#           FINAL_URL="${BASE_URL}&league=${LEAGUE_ID}&season=${SEASON}"
#           echo "Fetching rounds: $FINAL_URL"

#           CODE=$(curl -sS --connect-timeout 5 --max-time 25 -w "%{http_code}" -o "$TMPBODY" \
#             -H "x-rapidapi-key: ${RAPIDAPI_KEY}" \
#             -H "x-rapidapi-host: ${RAPIDAPI_HOST}" \
#             "$FINAL_URL" || true)

#           echo "code=$CODE" >> "$GITHUB_OUTPUT"
#           if [[ "$CODE" != "200" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           OK=$(jq -r '(.response | type) == "array"' "$TMPBODY")
#           if [[ "$OK" != "true" ]]; then
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#             exit 0
#           fi

#           TS=$(date -u +%FT%TZ)
#           NORM=$(mktemp)
#           jq --arg ts "$TS" '{rounds: .response, meta: { lastUpdatedUTC: $ts }}' "$TMPBODY" > "$NORM"

#           if ! cmp -s "$NORM" "$OUT"; then
#             mv "$NORM" "$OUT"
#             echo "changed=true" >> "$GITHUB_OUTPUT"
#           else
#             echo "changed=false" >> "$GITHUB_OUTPUT"
#           fi

#       - name: Clear post-window flag
#         if: steps.post_window.outputs.trigger == 'true' && (steps.standings.outputs.changed == 'true' || steps.scorers.outputs.changed == 'true' || steps.assists.outputs.changed == 'true' || steps.cards_yellow.outputs.changed == 'true' || steps.cards_red.outputs.changed == 'true')
#         shell: bash
#         run: |
#           set -euo pipefail
#           FLAG="data/ops/post_window.json"
#           if [[ -f "$FLAG" ]]; then
#             rm -f "$FLAG"
#             git config user.name "pl-bot"
#             git config user.email "pl-bot@users.noreply.github.com"
#             git add -A
#             git commit -m "Clear post-window trigger"
#             git push
#           fi

#       - name: Commit & push
#         if: steps.fixtures.outputs.changed == 'true' || steps.standings.outputs.changed == 'true' || steps.scorers.outputs.changed == 'true' || steps.assists.outputs.changed == 'true' || steps.cards_yellow.outputs.changed == 'true' || steps.cards_red.outputs.changed == 'true' || steps.fixtures_season.outputs.changed == 'true' || steps.teams.outputs.changed == 'true' || steps.venues.outputs.changed == 'true' || steps.rounds.outputs.changed == 'true'
#         run: |
#           git config user.name "pl-bot"
#           git config user.email "pl-bot@users.noreply.github.com"

#           git add data/football/premier-league/core/*.json
#           git add data/football/premier-league/fixtures/*.json
#           git add data/football/premier-league/live/*.json || true

#           git commit -m "Update core feeds (fixtures/standings/scorers/assists/cards/teams/venues/rounds)"
#           git push

