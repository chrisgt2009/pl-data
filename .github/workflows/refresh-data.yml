name: refresh-data

on:
  workflow_dispatch:
  schedule:
    # --- Live windows (UTC): every 10 minutes ---
    # Weekdays (Mon–Fri): 18:00–22:59
    - cron: "*/10 18-22 * * 1-5"
    # Weekends (Sat–Sun): 11:00–22:59
    - cron: "*/10 11-22 * * 6,0"

    # --- Outside live windows (lighter to save free minutes) ---
    # Weekdays (Mon–Fri): 4x/day
    - cron: "0 8,12,16,23 * * 1-5"
    # Weekends (Sat–Sun): 5x/day
    - cron: "0 9,12,15,18,21 * * 6,0"

permissions:
  contents: write
  actions: read

# Don't cancel in-progress runs.
concurrency:
  group: refresh-data-${{ github.ref }}
  cancel-in-progress: false

env:
  # Shared daily budget across refresh-data + fast-live/live-fast
  DAILY_LIMIT: "300"

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Daily budget gate ----------
      - id: quota
        name: Daily budget gate
        shell: bash
        env:
          DAILY_LIMIT: ${{ env.DAILY_LIMIT }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TODAY="$(date -u +%Y-%m-%d)"
          jq_count_today='[.[] | select(.createdAt | startswith(env.TODAY))] | length'

          used_refresh=$(gh run list --workflow "refresh-data" --json createdAt,status --limit 200 | jq -r "$jq_count_today")
          used_fast_a=$({ gh run list --workflow "fast-live" --json createdAt,status --limit 200 || echo "[]"; } | jq -r "$jq_count_today" 2>/dev/null || echo 0)
          used_fast_b=$({ gh run list --workflow "live-fast" --json createdAt,status --limit 200 || echo "[]"; } | jq -r "$jq_count_today" 2>/dev/null || echo 0)

          total=$(( used_refresh + used_fast_a + used_fast_b ))
          remaining=$(( DAILY_LIMIT - total ))
          (( remaining < 0 )) && remaining=0

          echo "used=$total" >> "$GITHUB_OUTPUT"
          echo "remaining=$remaining" >> "$GITHUB_OUTPUT"
          if (( total < DAILY_LIMIT )); then
            echo "allow=true"  >> "$GITHUB_OUTPUT"
          else
            echo "allow=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Budget exhausted — skip run
        if: steps.quota.outputs.allow == 'false'
        run: echo "Daily limit reached (used=${{ steps.quota.outputs.used }}). Skipping refresh."

      # ---------- Ensure repo paths ----------
      - name: Prepare data directory
        if: steps.quota.outputs.allow == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p data
          [[ -f data/etags.json ]] || echo '{}' > data/etags.json

      # ==================== FETCHERS ====================

      # ---- STANDINGS ----
      - id: standings
        if: steps.quota.outputs.allow == 'true'
        name: Refresh standings (ETag-aware)
        shell: bash
        env:
          URL: ${{ vars.URL_STANDINGS }}        # e.g. https://api.football-data.org/v4/competitions/PL/standings
          AUTH_HEADER: ${{ secrets.API_AUTH_HEADER }}
          EXTRA_HEADER: ${{ secrets.API_EXTRA_HEADER }}
        run: |
          set -euo pipefail
          KEY="standings"
          TMPHDR="$(mktemp)"; TMPBODY="$(mktemp)"

          [[ -z "${URL:-}" ]] && { echo "URL_STANDINGS not set; skipping."; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

          IN_ETAG=$(jq -r --arg k "$KEY" '.[$k] // empty' data/etags.json)
          HDRS=()
          [[ -n "${AUTH_HEADER:-}" ]]  && HDRS+=(-H "$AUTH_HEADER")
          [[ -n "${EXTRA_HEADER:-}" ]] && HDRS+=(-H "$EXTRA_HEADER")
          [[ -n "$IN_ETAG" ]] && HDRS+=(-H "If-None-Match: $IN_ETAG")

          CODE=$(curl -sS -w "%{http_code}" -D "$TMPHDR" -o "$TMPBODY" "${HDRS[@]}" "$URL")
          if [[ "$CODE" == "304" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          elif [[ "$CODE" != "200" ]]; then
            echo "HTTP $CODE from $URL — skipping"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          fi

          # normalize + write only if different
          NORM="$(mktemp)"
          jq -S -c '.' "$TMPBODY" > "$NORM" || { echo "Bad JSON"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }
          if ! cmp -s "$NORM" "data/standings.json"; then
            mv "$NORM" "data/standings.json"
            touch /tmp/changed-standings
          else
            rm -f "$NORM"
          fi

          NEW_ETAG=$(sed -n 's/^etag:[[:space:]]*//Ip' "$TMPHDR" | tr -d '\r' | tail -n1)
          if [[ -n "$NEW_ETAG" && "$NEW_ETAG" != "$IN_ETAG" ]]; then
            tmp="$(mktemp)"; jq --arg k "$KEY" --arg v "$NEW_ETAG" '.[$k]=$v' data/etags.json > "$tmp" && mv "$tmp" data/etags.json
          fi
          echo "changed=$([[ -f /tmp/changed-standings ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      # ---- FIXTURES (NEXT 30 DAYS, URL-keyed ETag) ----
      - id: fixtures_week
        if: steps.quota.outputs.allow == 'true'
        name: Refresh fixtures (next 30 days, ETag-aware)
        shell: bash
        env:
          BASE: ${{ vars.URL_FIXTURES_WEEK }}   # set to https://api.football-data.org/v4/competitions/PL/matches
          AUTH_HEADER: ${{ secrets.API_AUTH_HEADER }}
          EXTRA_HEADER: ${{ secrets.API_EXTRA_HEADER }}
        run: |
          set -euo pipefail
          KEY="fixtures_week"
          TMPHDR="$(mktemp)"; TMPBODY="$(mktemp)"
          : "${BASE:=https://api.football-data.org/v4/competitions/PL/matches}"

          DATE_FROM="$(date -u +%Y-%m-%d)"
          DATE_TO="$(date -u -d '+30 days' +%Y-%m-%d)"
          SEP='?'; [[ "${BASE}" == *\?* ]] && SEP='&'
          URL="${BASE}${SEP}dateFrom=${DATE_FROM}&dateTo=${DATE_TO}"
          echo "Fetching: $URL"

          URLHASH="$(printf '%s' "$URL" | sha1sum | awk '{print $1}' | cut -c1-12)"
          EKEY="${KEY}|${URLHASH}"

          IN_ETAG=$(jq -r --arg k "$EKEY" '.[$k] // empty' data/etags.json 2>/dev/null || echo "")
          HDRS=()
          [[ -n "${AUTH_HEADER:-}" ]]  && HDRS+=(-H "$AUTH_HEADER")
          [[ -n "${EXTRA_HEADER:-}" ]] && HDRS+=(-H "$EXTRA_HEADER")
          [[ -n "$IN_ETAG" ]] && HDRS+=(-H "If-None-Match: $IN_ETAG")

          CODE=$(curl -sS -w "%{http_code}" -D "$TMPHDR" -o "$TMPBODY" "${HDRS[@]}" "$URL")
          if [[ "$CODE" == "304" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          elif [[ "$CODE" != "200" ]]; then
            echo "HTTP $CODE from $URL — skipping"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          fi

          NORM="$(mktemp)"
          jq -S -c '.' "$TMPBODY" > "$NORM" || { echo "Bad JSON"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }
          if ! cmp -s "$NORM" "data/fixtures_week.json"; then
            mv "$NORM" "data/fixtures_week.json"
            touch /tmp/changed-fixtures_week
          else
            rm -f "$NORM"
          fi

          NEW_ETAG=$(sed -n 's/^etag:[[:space:]]*//Ip' "$TMPHDR" | tr -d '\r' | tail -n1)
          if [[ -n "$NEW_ETAG" ]]; then
            tmp="$(mktemp)"; jq --arg k "$EKEY" --arg v "$NEW_ETAG" '.[$k]=$v' data/etags.json 2>/dev/null > "$tmp" || echo "{\"$EKEY\":\"$NEW_ETAG\"}" > "$tmp"; mv "$tmp" data/etags.json
            tmp2="$(mktemp)"; jq --arg v "$NEW_ETAG" '.["fixtures_week"]=$v' data/etags.json 2>/dev/null > "$tmp2" || echo "{\"fixtures_week\":\"$NEW_ETAG\"}" > "$tmp2"; mv "$tmp2" data/etags.json
          fi
          echo "changed=$([[ -f /tmp/changed-fixtures_week ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      # ---- SCORERS ----
      - id: scorers
        if: steps.quota.outputs.allow == 'true'
        name: Refresh scorers (ETag-aware)
        shell: bash
        env:
          URL: ${{ vars.URL_SCORERS }}           # e.g. https://api.football-data.org/v4/competitions/PL/scorers
          AUTH_HEADER: ${{ secrets.API_AUTH_HEADER }}
          EXTRA_HEADER: ${{ secrets.API_EXTRA_HEADER }}
        run: |
          set -euo pipefail
          KEY="scorers"
          TMPHDR="$(mktemp)"; TMPBODY="$(mktemp)"

          [[ -z "${URL:-}" ]] && { echo "URL_SCORERS not set; skipping."; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }

          IN_ETAG=$(jq -r --arg k "$KEY" '.[$k] // empty' data/etags.json)
          HDRS=()
          [[ -n "${AUTH_HEADER:-}" ]]  && HDRS+=(-H "$AUTH_HEADER")
          [[ -n "${EXTRA_HEADER:-}" ]] && HDRS+=(-H "$EXTRA_HEADER")
          [[ -n "$IN_ETAG" ]] && HDRS+=(-H "If-None-Match: $IN_ETAG")

          CODE=$(curl -sS -w "%{http_code}" -D "$TMPHDR" -o "$TMPBODY" "${HDRS[@]}" "$URL")
          if [[ "$CODE" == "304" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          elif [[ "$CODE" != "200" ]]; then
            echo "HTTP $CODE from $URL — skipping"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0
          fi

          NORM="$(mktemp)"
          jq -S -c '.' "$TMPBODY" > "$NORM" || { echo "Bad JSON"; echo "changed=false" >> "$GITHUB_OUTPUT"; exit 0; }
          if ! cmp -s "$NORM" "data/scorers.json"; then
            mv "$NORM" "data/scorers.json"
            touch /tmp/changed-scorers
          else
            rm -f "$NORM"
          fi

          NEW_ETAG=$(sed -n 's/^etag:[[:space:]]*//Ip' "$TMPHDR" | tr -d '\r' | tail -n1)
          if [[ -n "$NEW_ETAG" && "$NEW_ETAG" != "$IN_ETAG" ]]; then
            tmp="$(mktemp)"; jq --arg k "$KEY" --arg v "$NEW_ETAG" '.[$k]=$v' data/etags.json > "$tmp" && mv "$tmp" data/etags.json
          fi
          echo "changed=$([[ -f /tmp/changed-scorers ]] && echo true || echo false)" >> "$GITHUB_OUTPUT"

      # ---------- meta.json ----------
      - id: meta
        if: steps.quota.outputs.allow == 'true' && (steps.standings.outputs.changed == 'true' || steps.fixtures_week.outputs.changed == 'true' || steps.scorers.outputs.changed == 'true')
        name: Update meta.json
        shell: bash
        run: |
          set -euo pipefail
          LAST="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          jq -S -c --arg t "$LAST" '
            .lastUpdatedUTC = $t
            | .artifacts = {
                standings:     {file:"data/standings.json",     etag:(.standings      // "")},
                fixtures_week: {file:"data/fixtures_week.json", etag:(."fixtures_week" // "")},
                scorers:       {file:"data/scorers.json",       etag:(.scorers        // "")}
              }
          ' data/etags.json \
          | jq -S -c '{lastUpdatedUTC, artifacts}' \
          > meta.new.json

          if ! cmp -s meta.new.json data/meta.json; then
            mv meta.new.json data/meta.json
            touch /tmp/changed-meta
          else
            rm -f meta.new.json
          fi

      # ---------- Commit only when something changed ----------
      - name: Commit & push
        if: steps.quota.outputs.allow == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/standings.json data/fixtures_week.json data/scorers.json data/meta.json data/etags.json 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update PL data $(date -u +%FT%TZ)"
            git push
          fi
