name: Refresh PL data (FREE-safe, serialized)

# Serialize refresh runs; never cancel mid-run
# Uses a different group than live so they don't conflict
concurrency:
  group: pl-refresh
  cancel-in-progress: false

on:
  schedule:
    # Safe, low-frequency updates on FREE plan
    - cron: "0 10,16,22 * * *"   # 10:00 / 16:00 / 22:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      FD_TOKEN: ${{ secrets.FD_API_TOKEN }}
      UA: pl-bot/1.0 (+github.com/${{ github.repository }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # allow rebase/pull before push

      - name: Ensure data dir
        run: mkdir -p data

      - name: Compute date window (UTC)
        id: dates
        shell: bash
        run: |
          set -euo pipefail
          echo "TODAY=$(date -u +%Y-%m-%d)" >> "$GITHUB_OUTPUT"
          echo "IN7=$(date -u -d '+7 days' +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Fetch with ETag (standings, fixtures_week, scorers)
        id: fetch
        shell: bash
        run: |
          set -euo pipefail

          # Read previous ETags (tolerate missing file)
          if [ -f data/etags.json ]; then
            ETAG_S=$(python -c 'import json;print(json.load(open("data/etags.json")).get("standings.json",""))' 2>/dev/null || true)
            ETAG_W=$(python -c 'import json;print(json.load(open("data/etags.json")).get("fixtures_week.json",""))' 2>/dev/null || true)
            ETAG_SC=$(python -c 'import json;print(json.load(open("data/etags.json")).get("scorers.json",""))' 2>/dev/null || true)
          else
            ETAG_S=""; ETAG_W=""; ETAG_SC=""
          fi

          URL_S="https://api.football-data.org/v4/competitions/PL/standings"
          URL_W="https://api.football-data.org/v4/competitions/PL/matches?dateFrom=${{ steps.dates.outputs.TODAY }}&dateTo=${{ steps.dates.outputs.IN7 }}"
          URL_SC="https://api.football-data.org/v4/competitions/PL/scorers?limit=30"

          fetch_one () {
            local url="$1" etag="$2" body="$3" head="$4"
            if [ -n "$etag" ]; then
              curl -sS --fail --retry 3 --retry-delay 2 --connect-timeout 15 \
                   -H "User-Agent: $UA" -H "X-Auth-Token: $FD_TOKEN" -H "If-None-Match: $etag" \
                   -D "$head" -o "$body" --write-out "%{http_code}" "$url"
            else
              curl -sS --fail --retry 3 --retry-delay 2 --connect-timeout 15 \
                   -H "User-Agent: $UA" -H "X-Auth-Token: $FD_TOKEN" \
                   -D "$head" -o "$body" --write-out "%{http_code}" "$url"
            fi
          }

          CODE_S=$(fetch_one "$URL_S" "$ETAG_S" standings.raw.json headers_s.txt || true)
          CODE_W=$(fetch_one "$URL_W" "$ETAG_W" fixtures_week.raw.json headers_w.txt || true)
          CODE_SC=$(fetch_one "$URL_SC" "$ETAG_SC" scorers.raw.json headers_sc.txt || true)

          echo "code_s=$CODE_S"   >> "$GITHUB_OUTPUT"
          echo "code_w=$CODE_W"   >> "$GITHUB_OUTPUT"
          echo "code_sc=$CODE_SC" >> "$GITHUB_OUTPUT"

          # ETag extraction
          extract_etag () {
            local file="$1"
            awk 'BEGIN{IGNORECASE=1} /^etag:/{print $2; exit}' "$file" 2>/dev/null | tr -d '\r' || true
          }

          ANY_CHANGED=false
          NEW_S=""; NEW_W=""; NEW_SC=""

          if [ "$CODE_S" = "200" ]; then ANY_CHANGED=true; NEW_S="$(extract_etag headers_s.txt)"; fi
          if [ "$CODE_W" = "200" ]; then ANY_CHANGED=true; NEW_W="$(extract_etag headers_w.txt)"; fi
          if [ "$CODE_SC" = "200" ]; then ANY_CHANGED=true; NEW_SC="$(extract_etag headers_sc.txt)"; fi

          echo "any_changed=$ANY_CHANGED" >> "$GITHUB_OUTPUT"
          echo "new_s=$NEW_S"   >> "$GITHUB_OUTPUT"
          echo "new_w=$NEW_W"   >> "$GITHUB_OUTPUT"
          echo "new_sc=$NEW_SC" >> "$GITHUB_OUTPUT"

      - name: Normalize / slim (only when changed)
        if: steps.fetch.outputs.any_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
import json, datetime
from datetime import timezone
now = datetime.datetime.now(timezone.utc)

with open("standings.raw.json") as f: standings = json.load(f)
with open("fixtures_week.raw.json") as f: fixtures_week = json.load(f)
try:
    with open("scorers.raw.json") as f: sc_raw = json.load(f)
except FileNotFoundError:
    sc_raw = {}

# Standings (slim)
out_s = {"season": standings.get("season"), "standings": standings.get("standings")}
json.dump(out_s, open("data/standings.new.json","w"), separators=(",",":"), sort_keys=True)

# Fixtures next 7 days (slim)
fw=[]
for m in (fixtures_week.get("matches") or []):
    fw.append({
        "id": m.get("id"),
        "utcDate": m.get("utcDate"),
        "status": m.get("status"),
        "matchday": m.get("matchday"),
        "competition": m.get("competition"),
        "homeTeam": m.get("homeTeam"),
        "awayTeam": m.get("awayTeam"),
        "score": (m.get("score") or {}),
    })
json.dump({
    "range": {"from": "${{ steps.dates.outputs.TODAY }}", "to": "${{ steps.dates.outputs.IN7 }}"},
    "matches": fw
}, open("data/fixtures_week.new.json","w"), separators=(",",":"), sort_keys=True)

# Top scorers (top 30)
top=[]
for s in (sc_raw.get("scorers") or [])[:30]:
    p=s.get("player") or {}; t=s.get("team") or {}
    top.append({
        "playerId": p.get("id"),
        "player": p.get("name"),
        "nationality": p.get("nationality"),
        "teamId": t.get("id"),
        "team": t.get("name"),
        "teamTLA": t.get("tla"),
        "teamCrest": t.get("crest"),
        "goals": s.get("goals"),
        "assists": s.get("assists"),
        "penalties": s.get("penalties")
    })
json.dump({"scorers": top}, open("data/scorers.new.json","w"),
          separators=(",",":"), sort_keys=True)

# Meta
json.dump({"lastUpdatedUTC": now.isoformat(), "serverNowUTC": now.isoformat()},
          open("data/meta.new.json","w"), separators=(",",":"), sort_keys=True)
PY

      - name: Write/merge ETags (only when changed)
        if: steps.fetch.outputs.any_changed == 'true'
        shell: bash
        env:
          NEW_S:  ${{ steps.fetch.outputs.new_s }}
          NEW_W:  ${{ steps.fetch.outputs.new_w }}
          NEW_SC: ${{ steps.fetch.outputs.new_sc }}
        run: |
          set -euo pipefail
          python - <<'PY'
import json, os
p='data/etags.json'
et={}
if os.path.exists(p):
  try: et=json.load(open(p))
  except: et={}
ns=os.environ.get('NEW_S','')
nw=os.environ.get('NEW_W','')
nsc=os.environ.get('NEW_SC','')
if ns:  et['standings.json']=ns
if nw:  et['fixtures_week.json']=nw
if nsc: et['scorers.json']=nsc
json.dump(et, open('data/etags.new.json','w'), separators=(',',':'), sort_keys=True)
PY

      - name: Commit only if changed
        if: steps.fetch.outputs.any_changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          CHANGED=0
          for f in standings fixtures_week scorers meta etags; do
            if [ -f "data/$f.json" ] && [ -f "data/$f.new.json" ]; then
              if cmp -s "data/$f.new.json" "data/$f.json"; then
                rm -f "data/$f.new.json"
              else
                mv "data/$f.new.json" "data/$f.json"
                CHANGED=1
              fi
            elif [ -f "data/$f.new.json" ]; then
              mv "data/$f.new.json" "data/$f.json"
              CHANGED=1
            fi
          done

          # clean temps
          rm -f headers_*.txt *.raw.json || true

          if [ $CHANGED -eq 1 ]; then
            git config user.name "pl-bot"
            git config user.email "pl-bot@users.noreply.github.com"
            git add data/standings.json data/fixtures_week.json data/scorers.json data/meta.json data/etags.json
            git commit -m "Update PL data $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git fetch origin main
            git pull --rebase origin main || true
            if ! git push origin HEAD:main; then
              echo "Push failed; retrying after rebase..."
              git pull --rebase origin main || true
              git push origin HEAD:main
            fi
          else
            echo "No JSON changes to commit."
          fi
